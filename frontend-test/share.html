<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexAnon - Shared Portfolio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        /* Stale Data Banner */
        .stale-banner {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .stale-banner.active {
            display: block;
        }

        .stale-banner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stale-message {
            color: #856404;
            font-weight: 500;
        }

        .stale-actions {
            display: flex;
            gap: 10px;
        }

        .unverified-banner {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            color: #1565c0;
        }

        .unverified-banner.active {
            display: block;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Portfolio Sections */
        .portfolio-section {
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 16px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #e8f5e9;
            color: #4caf50;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .live-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #e3f2fd;
            color: #2196f3;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .portfolio-card {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
        }

        .stat:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
        }

        .stat-value {
            color: #333;
            font-weight: 600;
        }

        .positive {
            color: #4caf50;
        }

        .negative {
            color: #f44336;
        }

        .change-badge {
            display: inline-block;
            background: #e8f5e9;
            color: #4caf50;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 10px;
        }

        .assets {
            margin-top: 30px;
        }

        .assets h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .asset {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .asset-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            background: #e0e0e0;
        }

        .asset-info {
            flex: 1;
        }

        .asset-symbol {
            font-weight: 600;
            color: #333;
        }

        .asset-name {
            font-size: 12px;
            color: #999;
        }

        .asset-value {
            text-align: right;
            font-weight: 600;
            color: #333;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #999;
            font-size: 12px;
        }

        .privacy-badge {
            display: inline-block;
            background: #e8f5e9;
            color: #4caf50;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FlexAnon</h1>
            <p class="subtitle">Privacy-first portfolio sharing</p>
        </div>

        <div id="content">
            <div class="loading">Loading portfolio data...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let currentToken = null;
        let committedData = null;
        let liveData = null;

        async function loadShareData() {
            try {
                const path = window.location.pathname;
                const token = path.split('/').pop();
                currentToken = token;

                if (!token) {
                    throw new Error('No share token provided');
                }

                // Fetch committed (on-chain) data
                const response = await fetch(`${API_BASE}/share/resolve?token=${token}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load portfolio');
                }

                committedData = data;
                displayPortfolio(data, 'committed');

                // Check if data is stale (older than 1 hour)
                // Parse committed_at from ISO string
                let commitmentMs = 0;
                if (data.committed_at) {
                    commitmentMs = new Date(data.committed_at).getTime();
                }
                
                const age = Date.now() - commitmentMs;
                const isStale = age > 60000; // TEST: 1 minute for demo

                // Always show the update time info
                if (commitmentMs > 0) {
                    const hours = Math.floor(age / 3600000);
                    const minutes = Math.floor((age % 3600000) / 60000);
                    
                    let ageText = '';
                    if (hours > 0) {
                        ageText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
                    } else if (minutes > 0) {
                        ageText = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                    } else {
                        ageText = 'just now';
                    }
                    
                    console.log(`Portfolio age: ${ageText}`);
                    
                    // Show refresh option if older than 1 hour
                    if (isStale) {
                        showRefreshOption(age);
                    }
                }

            } catch (error) {
                console.error('Error loading share data:', error);
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <h2>Oops!</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function showRefreshOption(ageMs) {
            const hours = Math.floor(ageMs / 3600000);
            const minutes = Math.floor((ageMs % 3600000) / 60000);
            
            let ageText = '';
            if (hours > 0) {
                ageText = `${hours} hour${hours > 1 ? 's' : ''}`;
            } else {
                ageText = `${minutes} minute${minutes > 1 ? 's' : ''}`;
            }

            const banner = document.createElement('div');
            banner.className = 'stale-banner active';
            banner.innerHTML = `
                <div class="stale-banner-content">
                    <div class="stale-message">
                        ℹ️ This data was verified ${ageText} ago and committed to the Solana blockchain.
                    </div>
                </div>
            `;

            const content = document.getElementById('content');
            content.insertBefore(banner, content.firstChild);
        }

        async function viewUnverifiedLatest() {
            try {
                const btn = event ? event.target : document.querySelector('.btn-primary');
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = 'Loading...';
                }

                showStatus('Fetching latest data from Zerion...', 'info');

                // Extract wallet from committed data (if available in revealed data)
                const walletAddress = committedData.revealed_data?.wallet_address;
                
                if (!walletAddress) {
                    // Wallet is hidden for privacy, can't fetch latest
                    throw new Error('Cannot fetch latest data: wallet address is hidden for privacy. Only the owner can refresh this portfolio.');
                }

                // Fetch latest data from Zerion via backend
                const response = await fetch(`${API_BASE}/dev/test-zerion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet_address: walletAddress })
                });

                const result = await response.json();

                if (result.success && result.portfolio) {
                    liveData = result.portfolio;
                    
                    // Hide stale banner
                    const staleBanner = document.querySelector('.stale-banner');
                    if (staleBanner) staleBanner.remove();
                    
                    // Show unverified warning
                    showUnverifiedWarning();
                    
                    // Display live data
                    displayLiveData(liveData);
                    
                    if (btn) btn.textContent = '✓ Showing Latest';
                    hideStatus();
                } else {
                    throw new Error('Failed to fetch latest data');
                }

            } catch (error) {
                console.error('Error fetching latest data:', error);
                showStatus('Failed: ' + error.message, 'error');
                const btn = event ? event.target : document.querySelector('.btn-primary');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '⚡ View Latest (Unverified)';
                }
            }
        }

        function showStatus(message, type = 'info') {
            // Remove existing status if any
            const existingStatus = document.querySelector('.status-message');
            if (existingStatus) existingStatus.remove();

            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#2196f3'};
                color: white;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);

            // Add animation
            if (!document.getElementById('status-animation-style')) {
                const style = document.createElement('style');
                style.id = 'status-animation-style';
                style.textContent = `
                    @keyframes slideIn {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function hideStatus() {
            const statusDiv = document.querySelector('.status-message');
            if (statusDiv) {
                statusDiv.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => statusDiv.remove(), 300);
            }
        }

        function showUnverifiedWarning() {
            const warning = document.createElement('div');
            warning.className = 'unverified-banner active';
            warning.innerHTML = `
                <strong>⚡ Live Data (Unverified)</strong><br>
                This data was fetched directly from Zerion just now. It has NOT been verified on-chain.
                Only the portfolio owner can commit verified updates.
            `;
            
            const content = document.getElementById('content');
            content.insertBefore(warning, content.firstChild);
        }

        function displayLiveData(portfolio) {
            const content = document.getElementById('content');
            
            // Add live data section
            const liveSection = document.createElement('div');
            liveSection.className = 'portfolio-section';
            liveSection.innerHTML = `
                <div class="section-header">
                    <div class="section-title">Latest Data (Live)</div>
                    <div class="live-badge">⚡ LIVE (unverified)</div>
                </div>
                ${generatePortfolioCard(portfolio, 'live')}
                <div class="timestamp">
                    Fetched just now from Zerion
                </div>
            `;

            // Insert before committed data
            const committedSection = content.querySelector('.portfolio-section');
            content.insertBefore(liveSection, committedSection);

            // Show comparison if different
            showComparison();
        }

        function showComparison() {
            if (!committedData || !liveData) return;

            const committedValue = parseFloat(committedData.revealed_data?.total_value?.replace(/[^0-9.-]+/g, '')) || 0;
            const liveValue = liveData.total_value || 0;
            const change = liveValue - committedValue;
            const changePercent = committedValue > 0 ? ((change / committedValue) * 100).toFixed(2) : 0;

            if (Math.abs(change) > 0.01) {
                const changeClass = change > 0 ? 'positive' : 'negative';
                const changeSymbol = change > 0 ? '+' : '';
                
                // Add change badge to live data
                const liveValueStat = document.querySelector('.portfolio-section .stat-value');
                if (liveValueStat && !liveValueStat.querySelector('.change-badge')) {
                    liveValueStat.innerHTML += `
                        <span class="change-badge ${changeClass}">
                            ${changeSymbol}$${Math.abs(change).toFixed(2)} (${changeSymbol}${changePercent}%)
                        </span>
                    `;
                }
            }
        }

        function generatePortfolioCard(data, type) {
            let html = '<div class="portfolio-card">';
            
            // Determine value source
            const value = type === 'live' 
                ? `$${data.total_value?.toFixed(2) || '0.00'}`
                : data.total_value || '$0.00';
            
            const pnl = type === 'live'
                ? `${data.pnl_percentage >= 0 ? '+' : ''}${data.pnl_percentage?.toFixed(2) || '0'}%`
                : data.pnl_percentage || '0%';

            // Total value
            html += `
                <div class="stat">
                    <span class="stat-label">Total Portfolio Value</span>
                    <span class="stat-value">${value}</span>
                </div>
            `;

            // PnL
            const isPositive = pnl.startsWith('+');
            html += `
                <div class="stat">
                    <span class="stat-label">Profit/Loss</span>
                    <span class="stat-value ${isPositive ? 'positive' : 'negative'}">
                        ${pnl}
                    </span>
                </div>
            `;

            // Chain
            const chain = type === 'live' ? data.chain : data.chain;
            if (chain) {
                html += `
                    <div class="stat">
                        <span class="stat-label">Network</span>
                        <span class="stat-value">${chain.toUpperCase()}</span>
                    </div>
                `;
            }

            // Assets count
            const assetsCount = type === 'live' 
                ? data.assets?.length 
                : data.total_assets_count;
            if (assetsCount) {
                html += `
                    <div class="stat">
                        <span class="stat-label">Total Assets</span>
                        <span class="stat-value">${assetsCount}</span>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        function displayPortfolio(data, type) {
            const content = document.getElementById('content');
            
            console.log('Portfolio data:', data);
            
            let html = `
                <div class="portfolio-section">
                    <div class="section-header">
                        <div class="section-title">Committed On-Chain</div>
                        <div class="verified-badge">✓ VERIFIED</div>
                    </div>
            `;
            
            html += '<div class="portfolio-card">';
            
            // Total value
            if (data.revealed_data?.total_value) {
                html += `
                    <div class="stat">
                        <span class="stat-label">Total Portfolio Value</span>
                        <span class="stat-value">${data.revealed_data.total_value}</span>
                    </div>
                `;
            }

            // PnL
            if (data.revealed_data?.pnl_percentage) {
                const isPositive = data.revealed_data.pnl_percentage.startsWith('+');
                html += `
                    <div class="stat">
                        <span class="stat-label">Profit/Loss</span>
                        <span class="stat-value ${isPositive ? 'positive' : 'negative'}">
                            ${data.revealed_data.pnl_percentage}
                        </span>
                    </div>
                `;
            }

            // Chain
            if (data.revealed_data?.chain) {
                html += `
                    <div class="stat">
                        <span class="stat-label">Network</span>
                        <span class="stat-value">${data.revealed_data.chain.toUpperCase()}</span>
                    </div>
                `;
            }

            // Assets count
            if (data.revealed_data?.total_assets_count) {
                html += `
                    <div class="stat">
                        <span class="stat-label">Total Assets</span>
                        <span class="stat-value">${data.revealed_data.total_assets_count}</span>
                    </div>
                `;
            }

            // Snapshot time
            if (data.revealed_data?.snapshot_time) {
                const date = new Date(data.revealed_data.snapshot_time);
                html += `
                    <div class="stat">
                        <span class="stat-label">Snapshot</span>
                        <span class="stat-value">${date.toLocaleString()}</span>
                    </div>
                `;
            }

            html += '</div>';
            
            // Add "Last Updated" timestamp
            if (data.committed_at) {
                const committedDate = new Date(data.committed_at);
                const now = Date.now();
                const age = now - committedDate.getTime();
                
                const hours = Math.floor(age / 3600000);
                const minutes = Math.floor((age % 3600000) / 60000);
                
                let ageText = '';
                if (hours > 0) {
                    ageText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
                } else if (minutes > 0) {
                    ageText = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                } else {
                    ageText = 'just now';
                }
                
                html += `
                    <div class="timestamp" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                        <strong>Last Updated:</strong> ${ageText} (${committedDate.toLocaleString()})
                    </div>
                `;
            }
            
            html += `<div class="timestamp">Committed to Solana blockchain</div>`;
            html += '</div>';

            // Top assets
            if (data.revealed_data?.top_assets && data.revealed_data.top_assets.length > 0) {
                html += '<div class="assets">';
                html += '<h2>Top Assets</h2>';
                
                data.revealed_data.top_assets.forEach(asset => {
                    html += `
                        <div class="asset">
                            ${asset.icon_url ? 
                                `<img src="${asset.icon_url}" class="asset-icon" alt="${asset.symbol}">` :
                                `<div class="asset-icon"></div>`
                            }
                            <div class="asset-info">
                                <div class="asset-symbol">${asset.symbol}</div>
                                <div class="asset-name">${asset.name || asset.symbol}</div>
                            </div>
                            <div class="asset-value">
                                <div>${asset.value_usd}</div>
                                <div style="font-size: 12px; color: #999;">${asset.amount}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }

            // Footer
            const privacyScore = data.privacy_score || data.metadata?.privacy_score || 0;
            const revealedCount = data.revealed_count || data.metadata?.revealed_count || 0;
            const totalCount = data.total_count || data.metadata?.total_count || 0;
            
            html += `
                <div class="footer">
                    <div style="margin-bottom: 10px;">
                        <span class="privacy-badge">🔒 ${privacyScore}% Private</span>
                    </div>
                    <p>This portfolio is shared via FlexAnon with privacy-preserving commitments.</p>
                    <p style="margin-top: 5px; font-size: 11px;">
                        Showing ${revealedCount} of ${totalCount} items
                    </p>
                </div>
            `;

            content.innerHTML = html;
        }

        // Load data when page loads
        window.addEventListener('load', loadShareData);
    </script>
</body>
</html>

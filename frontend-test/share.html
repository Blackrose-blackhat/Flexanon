'use client'

import React, { useEffect, useState } from 'react'
import { motion } from 'framer-motion'
import { toast } from 'sonner'
import { Shield, CheckCircle, ExternalLink, Copy, AlertCircle, Clock, Zap } from 'lucide-react'
import { Button } from '@/components/ui/button'
import PortfolioValue from './portfolio-value-safe'
import BalanceChart from './balance-chart-safe'
import TopAssetsList from './top-assets-list-safe'
import PortfolioPerformance from './portfolio-performance-fixed'
import AssetAllocation from './asset-allocation-safe'
import AssetCards from './asset-cards-dark'
import PortfolioMetrics from './portfolio-metrics-public'
import TopMovers from './top-movers-fixed'
import QuickStats from './quick-stats-safe'

interface ShareablePortfolioProps {
  shareId: string
  apiBase?: string
}

export default function ShareablePortfolio({ 
  shareId, 
  apiBase = process.env.NEXT_PUBLIC_BACKEND_URL || 'https://flexanon-delta.vercel.app/api' 
}: ShareablePortfolioProps) {
  // Committed (on-chain verified) data
  const [committedData, setCommittedData] = useState<any>(null)
  
  // Live (unverified) data
  const [liveData, setLiveData] = useState<any>(null)
  
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [isStale, setIsStale] = useState(false)

  useEffect(() => {
    loadShareData()
  }, [shareId])

  const loadShareData = async () => {
    setLoading(true)
    setError(null)

    try {
      // Step 1: Fetch committed (verified) data
      const response = await fetch(`${apiBase}/share/${shareId}`)
      
      if (!response.ok) {
        if (response.status === 404) {
          throw new Error('Portfolio not found or has expired')
        }
        throw new Error('Failed to load portfolio')
      }

      const data = await response.json()

      if (!data.success) {
        throw new Error(data.error || 'Failed to load portfolio')
      }

      setCommittedData(data)

      // Check if data is stale (older than 1 hour)
      if (data.committed_at) {
        const committedDate = new Date(data.committed_at)
        const now = Date.now()
        const age = now - committedDate.getTime()
        const oneHour = 3600000
        
        if (age > oneHour) {
          setIsStale(true)
          // Optionally fetch live data to show comparison
          await fetchLiveData(data.wallet_address)
        }
      }

    } catch (e: any) {
      console.error('Failed to fetch shared portfolio:', e)
      setError(e?.message || 'Failed to load portfolio')
      toast.error(e?.message || 'Failed to load shared portfolio')
    } finally {
      setLoading(false)
    }
  }

  const fetchLiveData = async (walletAddress?: string) => {
    if (!walletAddress) return

    try {
      const response = await fetch(`${apiBase}/dev/test-zerion`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: walletAddress })
      })

      const data = await response.json()
      
      if (data.success && data.portfolio) {
        setLiveData(data.portfolio)
      }
    } catch (e) {
      console.error('Failed to fetch live data:', e)
    }
  }

  const copyLink = () => {
    const url = window.location.href
    navigator.clipboard.writeText(url)
    toast.success('Link copied to clipboard!')
  }

  // Convert committed data to portfolio format
  const getCommittedPortfolio = () => {
    if (!committedData?.revealed_data) return null

    return {
      total_value: parseFloat(committedData.revealed_data.total_value?.replace(/[^0-9.-]+/g, '') || '0'),
      pnl_percentage: parseFloat(committedData.revealed_data.pnl_percentage?.replace(/[^0-9.-]+/g, '') || '0') / 100,
      assets_count: committedData.revealed_data.total_assets_count || 0,
      chain: committedData.revealed_data.chain || 'solana',
      snapshot_timestamp: committedData.revealed_data.snapshot_time,
    }
  }

  // Convert live data to portfolio format
  const getLivePortfolio = () => {
    if (!liveData) return null

    return {
      total_value: liveData.total_value || 0,
      pnl_percentage: liveData.pnl_percentage || 0,
      assets_count: liveData.assets?.length || 0,
      chain: liveData.chain || 'solana',
      snapshot_timestamp: new Date().toISOString(),
    }
  }

  // Convert assets to positions
  const getPositions = (source: 'committed' | 'live') => {
    const assets = source === 'committed' 
      ? committedData?.revealed_data?.top_assets || []
      : liveData?.assets || []

    return assets.map((asset: any, index: number) => ({
      position: index + 1,
      symbol: asset.symbol || 'UNKNOWN',
      name: asset.name || asset.symbol,
      quantity: asset.amount || '0',
      price: parseFloat(asset.value_usd?.replace(/[^0-9.-]+/g, '') || '0') / parseFloat(asset.amount || '1'),
      value: parseFloat(asset.value_usd?.replace(/[^0-9.-]+/g, '') || '0'),
      icon_url: asset.icon_url,
      asset_code: asset.symbol,
      changes: {
        percent_1d: Math.random() * 0.1 - 0.05,
        absolute_1d: 0
      }
    }))
  }

  // Calculate change between committed and live
  const getChangeInfo = () => {
    if (!committedData || !liveData) return null

    const committedValue = parseFloat(committedData.revealed_data?.total_value?.replace(/[^0-9.-]+/g, '') || '0')
    const liveValue = liveData.total_value || 0
    const change = liveValue - committedValue
    const changePercent = committedValue > 0 ? ((change / committedValue) * 100) : 0

    return {
      change,
      changePercent,
      isPositive: change >= 0
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <div className="text-center space-y-4">
          <div className="relative w-16 h-16 mx-auto">
            <div className="absolute inset-0 rounded-full border-4 border-gray-200"></div>
            <div className="absolute inset-0 rounded-full border-4 border-blue-600 border-t-transparent animate-spin"></div>
          </div>
          <p className="text-gray-600 font-medium text-lg">Loading portfolio...</p>
          <p className="text-gray-400 text-sm">Verifying on-chain commitment</p>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center p-4">
        <div className="text-center space-y-6 max-w-md">
          <div className="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto">
            <AlertCircle className="w-10 h-10 text-red-600" />
          </div>
          <h2 className="text-3xl font-bold text-gray-900">Portfolio Not Found</h2>
          <p className="text-gray-600 text-lg">{error}</p>
          <Button
            onClick={() => window.location.href = '/'}
            className="bg-gray-900 hover:bg-gray-800 text-white w-full"
            size="lg"
          >
            Go to Homepage
          </Button>
        </div>
      </div>
    )
  }

  const committedPortfolio = getCommittedPortfolio()
  const livePortfolio = getLivePortfolio()
  const changeInfo = getChangeInfo()
  const displayPortfolio = liveData ? livePortfolio : committedPortfolio
  const displayPositions = getPositions(liveData ? 'live' : 'committed')

  // Calculate age of committed data
  const getDataAge = () => {
    if (!committedData?.committed_at) return null
    
    const committedDate = new Date(committedData.committed_at)
    const now = Date.now()
    const age = now - committedDate.getTime()
    
    const hours = Math.floor(age / 3600000)
    const minutes = Math.floor((age % 3600000) / 60000)
    
    if (hours > 0) {
      return `${hours} hour${hours > 1 ? 's' : ''} ago`
    } else if (minutes > 0) {
      return `${minutes} minute${minutes > 1 ? 's' : ''} ago`
    }
    return 'just now'
  }

  return (
    <div className="min-h-screen bg-white">
      <div className="max-w-[1600px] mx-auto px-4 md:px-8 py-8 md:py-12">
        
        {/* Header */}
        <motion.div 
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="mb-8"
        >
          <div className="text-center mb-8">
            <div className="inline-flex items-center gap-3 mb-6">
              <div className="relative">
                <div className="absolute inset-0 bg-gradient-to-r from-emerald-600 to-blue-600 rounded-2xl blur-xl opacity-30"></div>
                <div className="relative bg-gradient-to-br from-emerald-600 to-blue-600 rounded-2xl p-4">
                  <Shield className="w-8 h-8 text-white" />
                </div>
              </div>
            </div>

            <div className="inline-flex items-center gap-2 bg-emerald-50 border-2 border-emerald-200 rounded-full px-6 py-3 mb-4">
              <CheckCircle className="w-5 h-5 text-emerald-600" />
              <span className="text-emerald-800 font-bold text-sm">
                âœ“ Verified On-Chain
              </span>
            </div>

            <h1 className="text-5xl md:text-6xl font-black text-gray-900 mb-3 tracking-tight">
              Shared Portfolio
            </h1>
            <p className="text-gray-600 text-lg mb-6 font-medium">
              Zero-knowledge verified crypto holdings
            </p>

            <div className="flex flex-wrap items-center justify-center gap-3">
              <Button
                onClick={copyLink}
                variant="outline"
                size="lg"
                className="gap-2 rounded-full px-6 border-2 border-gray-900 hover:bg-gray-900 hover:text-white text-gray-900 font-semibold"
              >
                <Copy className="w-4 h-4" />
                Copy Link
              </Button>
              <Button
                onClick={() => window.open('/', '_blank')}
                size="lg"
                className="gap-2 bg-gray-900 hover:bg-gray-800 text-white rounded-full px-6 shadow-lg"
              >
                <ExternalLink className="w-4 h-4" />
                Create Your Own
              </Button>
            </div>
          </div>

          {/* Stale Data Banner */}
          {isStale && liveData && (
            <div className="max-w-3xl mx-auto bg-yellow-50 border-2 border-yellow-300 rounded-2xl p-4 mb-4">
              <div className="flex items-center justify-between flex-wrap gap-3">
                <div className="flex items-center gap-2">
                  <Clock className="w-5 h-5 text-yellow-700" />
                  <p className="text-yellow-800 font-semibold text-sm">
                    Data updated {getDataAge()}. Showing live comparison.
                  </p>
                </div>
                {changeInfo && Math.abs(changeInfo.change) > 0.01 && (
                  <div className={`px-3 py-1 rounded-full text-sm font-bold ${
                    changeInfo.isPositive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                  }`}>
                    {changeInfo.isPositive ? '+' : ''}${changeInfo.change.toFixed(2)} 
                    ({changeInfo.isPositive ? '+' : ''}{changeInfo.changePercent.toFixed(2)}%)
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Privacy Notice */}
          <div className="max-w-2xl mx-auto bg-blue-50 border-2 border-blue-200 rounded-2xl p-4 text-center">
            <p className="text-blue-800 text-sm font-medium">
              ðŸ”’ <strong>Privacy Protected:</strong> Wallet address hidden. 
              {committedData?.privacy_score && ` ${committedData.privacy_score}% private.`} 
              Cryptographically verified using zero-knowledge proofs.
            </p>
          </div>
        </motion.div>

        {/* Portfolio Grid */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.2 }}
        >
          {/* Show Live Data Badge if available */}
          {liveData && (
            <div className="mb-4 flex items-center justify-center gap-2 text-sm">
              <Zap className="w-4 h-4 text-blue-600" />
              <span className="text-blue-600 font-semibold">Showing live data (unverified)</span>
            </div>
          )}

          <div className="grid grid-cols-1 md:grid-cols-6 lg:grid-cols-12 gap-4 lg:gap-6 auto-rows-fr">
            
            {/* Portfolio Value */}
            <div className="md:col-span-3 lg:col-span-4 md:row-span-2">
              <div className="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 rounded-[2rem] p-8 shadow-2xl h-full min-h-[500px] flex flex-col">
                <PortfolioValue
                  totalValue={displayPortfolio?.total_value}
                  pnlPercentage={displayPortfolio?.pnl_percentage}
                  positions={displayPositions}
                />
              </div>
            </div>

            {/* Quick Stats */}
            <div className="md:col-span-3 lg:col-span-4">
              <div className="bg-white rounded-[2rem] p-6 h-full border-2 border-gray-900 shadow-lg">
                <QuickStats portfolio={displayPortfolio} />
              </div>
            </div>

            {/* Portfolio Performance */}
            <div className="md:col-span-3 lg:col-span-4">
              <div className="bg-white rounded-[2rem] p-6 h-full border-2 border-gray-900 shadow-lg">
                <PortfolioPerformance positions={displayPositions} />
              </div>
            </div>

            {/* Portfolio Metrics */}
            <div className="md:col-span-3 lg:col-span-4">
              <div className="bg-white rounded-[2rem] p-6 h-full border-2 border-gray-900 shadow-lg">
                <PortfolioMetrics 
                  portfolio={displayPortfolio} 
                  positions={displayPositions}
                  isPublicView={true}
                />
              </div>
            </div>

            {/* Asset Allocation */}
            <div className="md:col-span-3 lg:col-span-4">
              <div className="bg-white rounded-[2rem] p-6 h-full border-2 border-gray-900 shadow-lg">
                <AssetAllocation positions={displayPositions} totalValue={displayPortfolio?.total_value} />
              </div>
            </div>

            {/* Top Assets Table */}
            <div className="col-span-full">
              <div className="bg-white rounded-[2rem] p-8 border-2 border-gray-900 shadow-lg">
                <TopAssetsList positions={displayPositions} />
              </div>
            </div>

            {/* Asset Cards */}
            <div className="col-span-full">
              <div className="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 rounded-[2rem] p-8 md:p-10 shadow-2xl border-2 border-gray-900">
                <div className="flex items-center justify-between mb-8">
                  <h3 className="text-3xl font-bold text-white">Portfolio Assets</h3>
                  <div className="bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full border border-white/20">
                    <span className="text-sm font-semibold text-white">
                      {displayPositions?.length || 0} Holdings
                    </span>
                  </div>
                </div>
                <AssetCards positions={displayPositions} />
              </div>
            </div>

          </div>
        </motion.div>

        {/* Footer */}
        <motion.div 
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.4 }}
          className="mt-12 text-center space-y-4"
        >
          {committedData?.committed_at && (
            <p className="text-sm text-gray-500 font-medium">
              Committed on-chain: {new Date(committedData.committed_at).toLocaleString()} ({getDataAge()})
            </p>
          )}
          
          <div className="flex items-center justify-center gap-2 text-xs text-gray-600 font-medium">
            <Shield className="w-3 h-3 text-emerald-500" />
            <span>
              Showing {committedData?.revealed_count || 0} of {committedData?.total_count || 0} items - 
              {committedData?.privacy_score || 0}% private
            </span>
          </div>

          <div className="pt-6 border-t border-gray-200">
            <p className="text-sm text-gray-500">
              Powered by <span className="font-bold text-gray-900">FlexAnon</span> - 
              Privacy-preserving portfolio sharing
            </p>
          </div>
        </motion.div>

      </div>
    </div>
  )
}